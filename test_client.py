import requests
import json

BASE_URL = "http://localhost:8000"

def register_view():
    print(f"--- Registering Config-Driven View ---")
    
    # Instead of raw code, we send a configuration of operations.
    # This logic says: "Take 'val_1', add 500 to it, and call the result 'val_boosted'"
    config_ops = [
        {
            "type": "add",
            "input_col": "val_1",
            "value": 500,
            "output_col": "val_boosted"
        }
    ]

    payload = {
        "view_name": "config_generated_view",
        "input_request_sources": [
            {
                "name": "input_stats",
                "schema_fields": {
                    "val_1": "Float64"
                }
            }
        ],
        "input_feature_views": [], 
        "features": [
            {
                "name": "val_boosted",
                "dtype": "Float64"
            }
        ],
        # The new field replacing 'transformation_code'
        "transformation_config": config_ops
    }

    try:
        response = requests.post(f"{BASE_URL}/register/on-demand", json=payload)
        
        if response.status_code == 200:
            print("Success!")
            resp_data = response.json()
            print("Server Message:", resp_data["message"])
            print("\n--- Code Generated by Server ---")
            print(resp_data["generated_logic"])
        else:
            print(f"Failed with status {response.status_code}")
            print(f"Details: {response.text}")
            
    except requests.exceptions.RequestException as e:
        print(f"Connection error: {e}")

def check_view(view_name):
    print(f"\n--- Verifying View '{view_name}' exists ---")
    try:
        response = requests.get(f"{BASE_URL}/views/{view_name}")
        if response.status_code == 200:
            print(json.dumps(response.json(), indent=2))
        else:
            print(f"Verification failed: {response.status_code}")
    except Exception as e:
        print(e)

if __name__ == "__main__":
    register_view()
    check_view("config_generated_view")


